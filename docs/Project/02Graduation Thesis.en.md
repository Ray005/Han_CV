# Graduation Thesis: ROS-based UAV Leveling System (excerpt)

## Video

<div style="position: relative; padding: 30% 45%;">

<iframe style="position: absolute; width: 100%; height: 100%; left: 0; top: 0;" src="https://player.bilibili.com/player.html?aid=953554143&bvid=BV1Ms4y1g7dZ&cid=1125967224&page=1&autoplay=0&danmuku=0" frameborder="no" scrolling="no">

</iframe>

</div> 【Project#2】leveling system system show Site：Bilibili


## Abstract

Firstly, a semi-physical simulation based on the experimental box is conducted, and after collecting IMU data, the Mahony complementary filtering algorithm based on gyroscope and geomagnetic sensor is used for attitude solution, and the PI regulator parameters in the complementary filtering algorithm are adjusted to achieve higher attitude solution accuracy. The real-time performance of the system is improved by adjusting parameters such as frequency, with a view to solving the problem of control lag or insufficient control refinement.

Finally, ROS is used as an information communication bridge to obtain attitude information during the system design. And a simple PID control program was written using STM32 to write the sub-node that controls the motor to verify the practicality of the system attitude solution. Among them, the sub-node written by STM32 communicates with the upper computer computer through serial port, and Python programming is used in ROS, which has good portability and can be applied to the on-board computer.

**Keyword**: attitude detection, follow-me platform, IMU, ROS

## Semi-Physical Test - Experimental Box Attitude Detection Experiment

The experimental box of this experiment has the ability to solve the attitude in real time, reading the sensor parameters from IMU and sending them to MATLAB for solving. Attitude solving based on gyroscope only and attitude solving based on gyroscope and geomagnetic sensor meter are performed separately and compared with the pure inertial method based on gyroscope and accelerometer in the experimental box.

### Mahony complementary filtering algorithm and process

Complementary filtering requires the interference noise of the two signals to be at different frequencies. By setting the cutoff frequencies of the two filters, the fused signals are ensured to cover the demanded frequencies. In IMU attitude estimation, the complementary filter uses high-pass filtering for the gyroscope (low frequency noise) and low-frequency filtering for the accelerometer/magnetometer (high frequency noise). In complementary filtering, the cutoff frequencies of both filters are the same, and it is then necessary to trade-off them according to the value of the useful frequency. The following is the formula for Mahony's complementary filtering algorithm, and the attitude can be solved by iterating over the following equation.

![Untitled](%E6%9C%AC%E7%A7%91%E8%AE%BA%E6%96%87%EF%BC%9A%E5%9F%BA%E4%BA%8EROS%E7%9A%84%E6%97%A0%E4%BA%BA%E6%9C%BA%E8%B0%83%E5%B9%B3%E7%B3%BB%E7%BB%9F%EF%BC%88%E8%8A%82%E9%80%89%EF%BC%89%20adb834963fb14b4f9b0d34075949c992/Untitled.png)

![Untitled](%E6%9C%AC%E7%A7%91%E8%AE%BA%E6%96%87%EF%BC%9A%E5%9F%BA%E4%BA%8EROS%E7%9A%84%E6%97%A0%E4%BA%BA%E6%9C%BA%E8%B0%83%E5%B9%B3%E7%B3%BB%E7%BB%9F%EF%BC%88%E8%8A%82%E9%80%89%EF%BC%89%20adb834963fb14b4f9b0d34075949c992/Untitled%201.png)

![Untitled](%E6%9C%AC%E7%A7%91%E8%AE%BA%E6%96%87%EF%BC%9A%E5%9F%BA%E4%BA%8EROS%E7%9A%84%E6%97%A0%E4%BA%BA%E6%9C%BA%E8%B0%83%E5%B9%B3%E7%B3%BB%E7%BB%9F%EF%BC%88%E8%8A%82%E9%80%89%EF%BC%89%20adb834963fb14b4f9b0d34075949c992/Untitled%202.png)

represents the quaternion representation of the system attitude estimate; is the new interest generated by the PI regulator; and represents the error relationship between the measured inertia vectors and the predicted ones. The last term can be interpreted as the result of the fork product of vectors that coincide with each other is zero, while the deviations that do not coincide can be represented by this fork product.

The Mahony complementary filtering algorithm focuses on the use of the classical PI compensator to calculate the compensation value, a controller in a PID control system with a similar mathematical form and a similar function for error transfer. The proportional term is used to control the "confidence" of the sensor, and the integral term is used to eliminate static errors.

![Untitled](%E6%9C%AC%E7%A7%91%E8%AE%BA%E6%96%87%EF%BC%9A%E5%9F%BA%E4%BA%8EROS%E7%9A%84%E6%97%A0%E4%BA%BA%E6%9C%BA%E8%B0%83%E5%B9%B3%E7%B3%BB%E7%BB%9F%EF%BC%88%E8%8A%82%E9%80%89%EF%BC%89%20adb834963fb14b4f9b0d34075949c992/Untitled%203.png)

Figure Flow chart of Mahony complementary filtering algorithm

### Fusion results

Since the baseline data is obtained from the IMU (gyroscope and accelerometer) fusion, it has good dynamic characteristics and accuracy in a short integration time (within 1 minute), which can be used as a reference data to compare the effect of this experiment. The Mahony complementary filter is used in this experiment, and similar to the Kalman filter, the Mahony filter is also divided into prediction-correction. There are two parameters, whose parameter values will affect the filtering effect. is used to control the crossover frequency between accelerometer and gyroscope and is used to correct the gyroscope error. The following is the effect when taking different values, it can be seen that when taking 0.1, a better effect can be achieved.

![Untitled](%E6%9C%AC%E7%A7%91%E8%AE%BA%E6%96%87%EF%BC%9A%E5%9F%BA%E4%BA%8EROS%E7%9A%84%E6%97%A0%E4%BA%BA%E6%9C%BA%E8%B0%83%E5%B9%B3%E7%B3%BB%E7%BB%9F%EF%BC%88%E8%8A%82%E9%80%89%EF%BC%89%20adb834963fb14b4f9b0d34075949c992/Untitled%204.png)

Fig. Kalman filter effect of gyroscope and electromagnetic sensor AHRS attitude system

## Attitude detection and simple leveling system design for tracked vehicle follow-me platform

The above experiments basically prove the feasibility of attitude solution, and this section carries out the system design. The system mainly consists of attitude detection subsystem, information transfer subsystem and leveling control subsystem. The attitude detection subsystem uses handsfree hfi_a9 IMU for attitude measurement, which is an IMU sensor with nine-axis sensors, i.e., three-axis gyroscope, three-axis accelerometer and three-axis magnetometer, and can directly output attitude information. The information transfer subsystem is based on ROS and communicates with the motor lower unit using C language, programmed in STM32 platform, for feedback and control. Finally the leveling control subsystem is called to perform attitude control using a PID control algorithm.

### Attitude detection subsystem

- Basic operation

Use hfi_a9 IMU to detect vehicle attitude, use IMU in ROS environment. preparation work, download the driver software zip package. Ubuntu20.04, installed ROS-Noetic version, corresponding python version is python3, download the python3 driver software zip package. Install the ros_imu dependency package. Open a terminal and type in the terminal. Create a workspace, create the corresponding directory and extract the previously downloaded software driver tarball to the src directory after unzipping it. Compile and set environment variables. Check if the device can be detected, connect the IMU USB, check if the computer can recognize ttyUSB0, and after detecting ttyUSB0, assign permissions to ttyUSB0.

Connect the IMU to the computer via USB connection cable and run the ROS driver visualization program.

![Untitled](%E6%9C%AC%E7%A7%91%E8%AE%BA%E6%96%87%EF%BC%9A%E5%9F%BA%E4%BA%8EROS%E7%9A%84%E6%97%A0%E4%BA%BA%E6%9C%BA%E8%B0%83%E5%B9%B3%E7%B3%BB%E7%BB%9F%EF%BC%88%E8%8A%82%E9%80%89%EF%BC%89%20adb834963fb14b4f9b0d34075949c992/Untitled%205.png)

Figure 5.1 Visualization procedure

Run the script to get the IMU Euler angle format data: Roll (roll), Pitch (pitch), Yaw (yaw). At this time, turn the IMU, you will see the change of the model on the rviz, and realize the real-time detection of the vehicle attitude.

![Untitled](%E6%9C%AC%E7%A7%91%E8%AE%BA%E6%96%87%EF%BC%9A%E5%9F%BA%E4%BA%8EROS%E7%9A%84%E6%97%A0%E4%BA%BA%E6%9C%BA%E8%B0%83%E5%B9%B3%E7%B3%BB%E7%BB%9F%EF%BC%88%E8%8A%82%E9%80%89%EF%BC%89%20adb834963fb14b4f9b0d34075949c992/Untitled%206.png)

Figure 5.2 Obtaining Euler angle data

- Installation and commissioning

In order to determine the car body attitude without affecting the leveling of the landing platform surface and to prevent accidental touching during landing, the sensor is placed on the top of the cover for monitoring the car body attitude. It should be noted here that the monitoring object is the vehicle body attitude, not the leveling platform attitude, so it will not be affected by the bad stability of the control system causing the attitude detection effect, and it is easy to observe the effect of the attitude detection system.

![Untitled](%E6%9C%AC%E7%A7%91%E8%AE%BA%E6%96%87%EF%BC%9A%E5%9F%BA%E4%BA%8EROS%E7%9A%84%E6%97%A0%E4%BA%BA%E6%9C%BA%E8%B0%83%E5%B9%B3%E7%B3%BB%E7%BB%9F%EF%BC%88%E8%8A%82%E9%80%89%EF%BC%89%20adb834963fb14b4f9b0d34075949c992/Untitled%207.png)

Figure 5.3 Schematic diagram of IMU sensor placement (bottom left)

The figure shows the main body of the whole attitude leveling system under debugging, the cell phone on the platform is used to monitor whether the attitude change is smooth, the motor is controlled by STM32, and the information is fed back to the master node of the computer upper computer through the serial communication port, the master node calculates and passes the motor speed amount signal to the STM32 node, the process is all done through ROS, which is easy to reuse.

### ROS-based information transfer system

ROS, the full name of the robot operating system, is currently being updated and iterated, and is widely used in research and industry. Its convenient communication features are very characteristic and are important for the implementation of this project to enhance its modularity and portability.

- Master node and communication flow

rqt is a visualization tool written in qt for the ROS platform. Using rqt_graph the current node operation and subscription release can be plotted with a general graph of node communication as follows:

![Untitled](%E6%9C%AC%E7%A7%91%E8%AE%BA%E6%96%87%EF%BC%9A%E5%9F%BA%E4%BA%8EROS%E7%9A%84%E6%97%A0%E4%BA%BA%E6%9C%BA%E8%B0%83%E5%B9%B3%E7%B3%BB%E7%BB%9F%EF%BC%88%E8%8A%82%E9%80%89%EF%BC%89%20adb834963fb14b4f9b0d34075949c992/Untitled%208.png)

Figure 5.4 ROS system communication node diagram

In the master node, the program for PID control and receiving IMU sensor attitude data and encoder feedback position data is running. The master node controls the PWM duty cycle of the motor connected to the stm32 by issuing a topic named /pwm_duty/node1 for the purpose of controlling the motion and speed.

In the program, the position where the three pushers should be in order to keep the horizontal balance is inverted by the acquired information of the crawler's posture. At the same time, the PID system, after adjusting the PID parameters, takes the position of the pusher as the target quantity, outputs the difference between the target quantity and the actual quantity, and uses the PID to adjust the difference, so as to achieve the effect of controlling the balance.

![Untitled](%E6%9C%AC%E7%A7%91%E8%AE%BA%E6%96%87%EF%BC%9A%E5%9F%BA%E4%BA%8EROS%E7%9A%84%E6%97%A0%E4%BA%BA%E6%9C%BA%E8%B0%83%E5%B9%B3%E7%B3%BB%E7%BB%9F%EF%BC%88%E8%8A%82%E9%80%89%EF%BC%89%20adb834963fb14b4f9b0d34075949c992/Untitled%209.png)

Figure 5.5 Flowchart of the master node program

As the above figure shows the structure of the ROS master node operation, the flow of information exchange is completed through subscription and publication. The callback function is called after each received information, which plays the role of timely feedback data, timely calculation output and timely response.

### STM32 lower computer node and hardware design

The circuit part, with the help of the encoder mode of the STM32 timer, enables easy measurement of a wide range of encoder signals. The A and B phases of the spoken encoder are connected to the ports of the timer (only TIMx_CH1 and TIMx_CH2 of the STM32 support encoder mode), and thereafter the timer can be called for the purpose of speed measurement. The following figure shows the hardware circuit diagram of an STM32 motor node.

![Untitled](%E6%9C%AC%E7%A7%91%E8%AE%BA%E6%96%87%EF%BC%9A%E5%9F%BA%E4%BA%8EROS%E7%9A%84%E6%97%A0%E4%BA%BA%E6%9C%BA%E8%B0%83%E5%B9%B3%E7%B3%BB%E7%BB%9F%EF%BC%88%E8%8A%82%E9%80%89%EF%BC%89%20adb834963fb14b4f9b0d34075949c992/Untitled%2010.png)

Figure 5.6 Communication hardware and circuit driver structure

The STM32 interacts with the outside world with the following components: PWM duty cycle signals sent to the motor and encoder signals received, and a serial port for communication with the PC host computer. The PWM duty cycle signal is generated using the PB5 pin to control the speed of the motor lift, and PB15 and PB14 are used to control the forward and reverse rotation of the motor.

The program flow diagram of the STM32 lower computer node is as follows:

![Untitled](%E6%9C%AC%E7%A7%91%E8%AE%BA%E6%96%87%EF%BC%9A%E5%9F%BA%E4%BA%8EROS%E7%9A%84%E6%97%A0%E4%BA%BA%E6%9C%BA%E8%B0%83%E5%B9%B3%E7%B3%BB%E7%BB%9F%EF%BC%88%E8%8A%82%E9%80%89%EF%BC%89%20adb834963fb14b4f9b0d34075949c992/Untitled%2011.png)

Figure 5.7 STM32 sub-node program flowchart

The flow of use is as follows:Remove all serial connections from the computer, open the terminal and run roscore afterwards. Connect the Handsfree A9 IMU and run the Attitude Solver sub-node. Open another new terminal and run the master node. Connect the STM32's serial port to the computer, open another new terminal, and run the sub-node. The PID program and parameters are located in the Python program of the master node, which can be modified and restarted in time to see the results.

### Leveling control subsystem

As generally shown in the figure above, the callback function in the master node runs the PID control system by calculating its deviation and then using the method of PID regulator to control and adjust the position as the control target of the follower platform pushrod position.

For the combined dimensions of the platform, the height of the equilateral triangle was measured, where the frame was defined as one frame turned by the encoder grating. And by the geometric relationship can be will angle and offset relationship expressed by the following formula, and will be applied to calculate the target position.

![Untitled](%E6%9C%AC%E7%A7%91%E8%AE%BA%E6%96%87%EF%BC%9A%E5%9F%BA%E4%BA%8EROS%E7%9A%84%E6%97%A0%E4%BA%BA%E6%9C%BA%E8%B0%83%E5%B9%B3%E7%B3%BB%E7%BB%9F%EF%BC%88%E8%8A%82%E9%80%89%EF%BC%89%20adb834963fb14b4f9b0d34075949c992/Untitled%2012.png)

And when the angle θ is positive, the actuator moves outward, and when θ is negative, it moves backward. With this basic mathematical model, it can be used as the basic control target quantity for control.

The PID model of the simple control system can achieve a more robust and responsive control effect when the three parameters of the final manually rectified position-based PID are as follows. At the same time, a limit operation is used in the program to avoid abnormal values of the PID output and to improve the robustness of the model.

![Untitled](%E6%9C%AC%E7%A7%91%E8%AE%BA%E6%96%87%EF%BC%9A%E5%9F%BA%E4%BA%8EROS%E7%9A%84%E6%97%A0%E4%BA%BA%E6%9C%BA%E8%B0%83%E5%B9%B3%E7%B3%BB%E7%BB%9F%EF%BC%88%E8%8A%82%E9%80%89%EF%BC%89%20adb834963fb14b4f9b0d34075949c992/Untitled%2013.png)

Note that since you want to subscribe to and use data from both nodes at the same time, you need to synchronize their messages using message_filter and use the same callback function to control the computation. Details can be found in the appendix code.

### System effect

After total assembly, the circuit is shown below, with three nodes, each containing three parts: TTL to USB serial port, PWM driver and STM32 main control, which are connected using Dupont wire during the experiment. In addition the sensor is directly connected to the computer.

![Untitled](%E6%9C%AC%E7%A7%91%E8%AE%BA%E6%96%87%EF%BC%9A%E5%9F%BA%E4%BA%8EROS%E7%9A%84%E6%97%A0%E4%BA%BA%E6%9C%BA%E8%B0%83%E5%B9%B3%E7%B3%BB%E7%BB%9F%EF%BC%88%E8%8A%82%E9%80%89%EF%BC%89%20adb834963fb14b4f9b0d34075949c992/Untitled%2014.png)

Figure 5.8 Circuit actual installation diagram

When balancing, the attitude is shown in the figure below, and the pitch axis balance experiment is carried out, except for the positive axis, the other two pushers are at rest to test the pitch axis effect alone. At this time, the stationary axis is placed in 0 position, and the motion axis has only positive motion degrees of freedom, on which the level is turned on to monitor for visualization test.

![Untitled](%E6%9C%AC%E7%A7%91%E8%AE%BA%E6%96%87%EF%BC%9A%E5%9F%BA%E4%BA%8EROS%E7%9A%84%E6%97%A0%E4%BA%BA%E6%9C%BA%E8%B0%83%E5%B9%B3%E7%B3%BB%E7%BB%9F%EF%BC%88%E8%8A%82%E9%80%89%EF%BC%89%20adb834963fb14b4f9b0d34075949c992/Untitled%2015.png)

Figure 5.9 The follower platform in a balanced attitude

A series of angle tests were then performed, starting with a small angle test, using the other end of the cover as a pivot point and moving up and down manually to simulate the uncertain vibration undulations of a realistic tracked vehicle in motion.

The moving platform for monitoring showed almost zero angular fluctuation, which is the best result when the slow motion of small angles is accompanied by low latency and good follow-through, which is the type of vibration often found in crawler travel.

For faster movements at smaller angles, the delay starts to show up, the overshoot of the following platform starts to increase, and the visualized moving platform shows angle fluctuations in the range of 1°.

![Untitled](%E6%9C%AC%E7%A7%91%E8%AE%BA%E6%96%87%EF%BC%9A%E5%9F%BA%E4%BA%8EROS%E7%9A%84%E6%97%A0%E4%BA%BA%E6%9C%BA%E8%B0%83%E5%B9%B3%E7%B3%BB%E7%BB%9F%EF%BC%88%E8%8A%82%E9%80%89%EF%BC%89%20adb834963fb14b4f9b0d34075949c992/Untitled%2016.png)

Figure 5.10 Following motion platform at small angles

Further motion tests at larger angles still have a very smooth follow-through with slow motion at large angles, and the visualized moving platform shows angle fluctuations within 1°. Still has a good performance.

When performing fast motion at large angles, the leveling following delay rises, the amount of overshoot increases, the oscillation convergence time increases to about 2 seconds, and its overall leveling performance is greatly reduced.

![Untitled](%E6%9C%AC%E7%A7%91%E8%AE%BA%E6%96%87%EF%BC%9A%E5%9F%BA%E4%BA%8EROS%E7%9A%84%E6%97%A0%E4%BA%BA%E6%9C%BA%E8%B0%83%E5%B9%B3%E7%B3%BB%E7%BB%9F%EF%BC%88%E8%8A%82%E9%80%89%EF%BC%89%20adb834963fb14b4f9b0d34075949c992/Untitled%2017.png)

Fig. 5.11 The follower platform at large angles

Finally, it is concluded that the system responds quickly and with small overshoot at small angles, but the response time will increase and the overshoot will be higher at large angles. And the response real time and overshoot amount will be increased in the case of fast motion speed. However, it is enough to prove that the attitude detection part can sense the attitude correctly and has some practicality.

## Summary and outlook

### Main work

In order to realize the design of attitude detection and simple leveling system for tracked vehicle follow-on platform, we mainly conducted experiments and designs from offline data simulation, semi-physical testing of hardware sensors, design and verification of tracked vehicle follow-on platform system, and completed the basic process from theoretical foundation to system design. And tested the program of STM32 to write the lower computer and communicate with ROS to verify its feasibility. The basic leveling geometry model was established, pushed to its leveling formula, and applied to the PID control system. Finally, by the effect, a better stability is obtained, and it is concluded that the leveling mathematical model is established correctly and the attitude detection system has some practicality.

### Future and outlook

Improvements can be made in the following aspects:

- ① specific attitude detection algorithms can be designed for the vibration characteristics of the crawler platform in order to achieve better model stability, and the long-time operating characteristics should also be improved accordingly. For example, the analysis of the vibration sources of the tracked vehicle and the response design algorithm can be carried out.
- ② adjusting the attitude solution scheme, from the analysis in this design, the pure gyroscope attitude solution method does not have good resistance to time drift, although this experiment conducted Mahony complementary filtering algorithm for attitude solution, and proved its practicality to some extent, but still has certain limitations. If the cooperative filtering algorithm using GPS or BeiDou GPS is added under outdoor conditions, the time drift of the attitude solving model will be further reduced.
- ③ the improvement of PID control algorithm. From the current situation, the manually adjusted position-based PID controller, in the case of conservative parameters will still overshoot the phenomenon, which requires more nonlinear methods to join the controller to get a more excellent and highly robust control effect.
- ④ increase the plotting of PID control curves. The program code that feeds back the current position from the STM32 node and records the deviation from the target value should be added. This can enhance the grasp of the experimental results and more intuitive observation of the control effect.
- ⑤ instead of using encoder feedback to control the pusher motor, a vector control (FOC) method should be used for finer control of the AC motor. FOC is a control scheme for AC motors, which can achieve finer control of the AC motor phase compared to the traditional three-phase control, and can improve the zero drift of the system.
- ⑥ MEMS inertial sensors are installed on both the following platform and the carrier platform to further limit the following error of the following platform and improve the system performance by processing redundant sensing information through the feedback of both attitudes. Although this design uses only a single sensor mounted on the bottom cover and solidly connected to the tracked vehicle to reflect the position of the actuator through its attitude, this can reduce unnecessary vibration and improve the stability of the output of the attitude detection system, but this brings the problem that the action on the follower platform is not fed back to the control system, which will lead to a larger response time. By redundant sensor information, the optimal solution is sought to achieve better control.